<!DOCTYPE html>
<!-- Leaflet + D3 demo for Victoria LGAs (prettified, same logic) -->
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;700&display=swap" rel="stylesheet">

<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Victoria LGAs Map</title>

  <!-- libs -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  

  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

</head>
<body>

<!-- map + side panel -->
<div id="map"></div>

<div id="chart-panel">
  <h4 id="chart-title">LGA Info</h4>
  <button id="close-btn">Close</button>
  <div id="popup-plot"></div>
  <div id="tooltip" class="tooltip"></div>
</div>

<script>
/* Leaflet map */
const map = L.map('map').setView([-37.5, 144.5], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap contributors'
}).addTo(map);

/* cached DOM refs */
const panel   = document.getElementById('chart-panel');
const titleEl = document.getElementById('chart-title');
const plotEl  = document.getElementById('popup-plot');
const tooltip = d3.select('#tooltip');

document.getElementById('close-btn').onclick = () => (panel.style.display = 'none');

function showPanel(title) {
  titleEl.textContent = title;
  panel.style.display = 'block';
  plotEl.innerHTML = '';
  tooltip.style('opacity', 0);
}

/**
 * Append a data‐source link under the chart
 */
 function addSource(text, url) {
  const a = document.createElement('a');
  a.href       = url;
  a.target     = '_blank';
  a.rel        = 'noopener';
  a.textContent= text;
  a.className  = 'data-source';
  plotEl.appendChild(a);
}


/* load GeoJSON + pop‑ups */
fetch('vic_lga_cleaned.geojson')
  .then(r => r.json())
  .then(geo => {
    L.geoJSON(geo, {
      style: { color: '#444', weight: 1, fillColor: '#99ccff', fillOpacity: 0.6 },
      onEachFeature: (f, layer) => {
        const name = f.properties.LGA_NAME || f.properties.lga_name || 'Unknown';
        const code = f.properties.LGA_CODE24 || f.properties.lga_code || f.properties.code;
        layer.bindPopup(`
          <div style="width:260px">
            <strong>${name}</strong><br/>
            <button onclick="viewStats(${code})">View Statistics</button>
            <button onclick="viewNationalities(${code}, '${name}')">View Nationalities</button>
            <button onclick="viewNationalityRace(${code}, '${name}')">Play bar-race</button>
           <button onclick="viewLanguage(${code}, '${name}')">View Language</button>
          </div>`);
      }
    }).addTo(map);
  });


  function viewStats(code) {
  fetch(`/api/lga/statistics-full?code=${code}`)
    .then(r => r.json())
    .then(d => {
      showPanel('LGA Statistics');
      addSource(
        'Data Source: ABS Data Region Methodology (2011–24)',
        'https://www.abs.gov.au/methodologies/data-region-methodology/2011-24'
      );

      const cards = [
        { key:'total_businesses',               label:'Businesses',            unit:'',
          icon:'bi-shop' },
        { key:'total_employed_over_15',         label:'Employed (15+)',        unit:'',
          icon:'bi-briefcase-fill' },
        { key:'born_overseas',                  label:'Born overseas',         unit:'',
          icon:'bi-globe2' },
        { key:'pct_arrived_within_5_years',     label:'Arrived ≤5 yrs',        unit:'%',
          icon:'bi-airplane-engines' },
        { key:'pct_proficient_english',         label:'Proficient English',    unit:'%',
          icon:'bi-chat-dots-fill' },
        { key:'pct_speaks_other_lang_at_home', label:'Other lang @home',  unit:'%',
          icon:'bi-translate' },
        { key:'median_age_years',               label:'Median age',            unit:'yrs',
          icon:'bi-person-vcard' },
        { key:'pct_completed_year_12',          label:'Year-12 completed',     unit:'%',
          icon:'bi-mortarboard' },
        { key:'pct_certificate',                label:'Certificate',           unit:'%',
          icon:'bi-award-fill' },
        { key:'pct_bachelor_degree',            label:'Bachelor degree',       unit:'%',
          icon:'bi-mortarboard-fill' },
        { key:'pct_postgraduate',               label:'Post-graduate',         unit:'%',
          icon:'bi-journal-richtext' },
        { key:'pct_managers',                   label:'Managers',              unit:'%',
          icon:'bi-diagram-3-fill' },
        { key:'pct_professionals',              label:'Professionals',         unit:'%',
          icon:'bi-person-workspace' },
        { key:'pct_labourers',                  label:'Labourers',             unit:'%',
          icon:'bi-hammer' }
      ];

      /* HTML grid */
      const grid = document.createElement('div');
      grid.className = 'kpi-grid';

      grid.innerHTML = cards.map(c => {
        const raw = d[c.key];
        const val = raw == null ? '—'
                  : c.unit === '%'  ? (+raw).toFixed(1) + ' %'   // thin space before %
                  : c.unit === 'yrs'? (+raw).toFixed(1) + ' yrs'
                  : (+raw).toLocaleString();
        return `
          <div class="kpi-card">
            <i class="bi ${c.icon} kpi-icon"></i>
            <div class="kpi-value">${val}</div>
            <div class="kpi-label">${c.label}</div>
          </div>`;
      }).join('');

      plotEl.appendChild(grid);
    });
}



/* --- nationality bar chart --- */
function viewNationalities(code, lgaName) {
  fetch(`/api/lga/nationalities/${code}`)
    .then(r => r.json())
    .then(all => {
      showPanel('Nationality Trends');
      plotEl.innerHTML = '<label for="natSel"><strong>Select a nationality:</strong></label>' +
                         '<select id="natSel"></select>';
      const sel = document.getElementById('natSel');
      sel.innerHTML = all.map(d => `<option value="${d.nationality}">${d.nationality}</option>`).join('');

      const svg = d3.select(plotEl).append('svg').attr('width', 900).attr('height', 550);
      const m = { top: 60, right: 90, bottom: 60, left: 200 };
      const w = +svg.attr('width') - m.left - m.right;
      const h = +svg.attr('height') - m.top - m.bottom;
      const g = svg.append('g').attr('transform', `translate(${m.left},${m.top})`);
      const x = d3.scaleLinear().range([0, w]);
      const y = d3.scaleBand().range([0, h]).padding(0.1);
      const colour = d3.scaleOrdinal(d3.schemeCategory10);
      const fmt = d3.format(',');

      const titleG = svg.append('g')
        .attr('class', 'plot-title')
        .attr('transform', `translate(${m.left + w / 2}, 20)`);

      const titleTxt = titleG.append('text')
        .attr('text-anchor', 'middle')
        .attr('font-weight', 'bold')
        .attr('font-size', '22px')
        .text(`Top 10 Nationalities in ${lgaName}`);

      const iconSize = 25;                                
      const txtBox   = titleTxt.node().getBBox();

      titleG.append('svg')                                
        .attr('x',  txtBox.width / 2 + 3)              
        .attr('y', -iconSize / 2)                       
        .attr('width',  iconSize)
        .attr('height', iconSize)
        .html(`
        <path d="M5.793 1a1 1 0 0 1 1.414 0l.647.646a.5.5 0 1 1-.708.708L6.5 1.707 2 6.207V12.5a.5.5 0 0 0 .5.5.5.5 0 0 1 0 1A1.5 1.5 0 0 1 1 12.5V7.207l-.146.147a.5.5 0 0 1-.708-.708zm3 1a1 1 0 0 1 1.414 0L12 3.793V2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v3.293l1.854 1.853a.5.5 0 0 1-.708.708L15 8.207V13.5a1.5 1.5 0 0 1-1.5 1.5h-8A1.5 1.5 0 0 1 4 13.5V8.207l-.146.147a.5.5 0 1 1-.708-.708zm.707.707L5 7.207V13.5a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5V7.207z" 
              fill="currentColor"/>`);

      function draw(rows, animate = false) {
        x.domain([0, d3.max(rows, d => d.count)]).nice();
        y.domain(rows.map(d => d.nationality));

        const bars = g.selectAll('rect').data(rows, d => d.nationality);
        bars.exit().transition().duration(300).attr('width', 0).remove();
        const enter = bars.enter().append('rect')
          .attr('x', 0)
          .attr('y', d => y(d.nationality))
          .attr('height', y.bandwidth())
          .attr('fill', d => colour(d.nationality))
          .attr('opacity', 0)
          .attr('width', 0);
        const merged = enter.merge(bars);
        (animate ? merged.transition().delay((_, i) => i * 40).duration(750)
                 : merged.transition().duration(500))
          .attr('y', d => y(d.nationality))
          .attr('width', d => x(d.count))
          .attr('opacity', 1);

        merged.on('mouseover', function (e, d) {
          merged.attr('opacity', 0.2);
          d3.select(this).attr('opacity', 1);
          const b = this.getBoundingClientRect();
          const p = panel.getBoundingClientRect();
          tooltip.html(`<strong>
            <svg xmlns="http://www.w3.org/2000/svg"
            width="14" height="14" viewBox="0 0 16 16"
            style="vertical-align:middle;margin-right:4px">
            <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6m-5.784 6A2.24 2.24 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.3 6.3 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1zM4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5"/>
            </svg>Population</strong><br/>
            ${d.count.toLocaleString()}`)
            .style('left', b.right - p.left + 8 + 'px')
            .style('top',  b.top  - p.top  + b.height / 2 - 12 + 'px')
            .style('opacity', 1);

        }).on('mouseout', () => {
          merged.attr('opacity', 1);
          tooltip.style('opacity', 0);
        });

        g.selectAll('.y-axis').remove();
        g.append('g').attr('class', 'y-axis').call(d3.axisLeft(y));
        g.selectAll('.x-grid').remove();
        g.append('g').attr('class', 'x-grid')
          .call(d3.axisTop(x).ticks(5).tickSize(-h).tickSizeOuter(0))
          .call(g => g.select('.domain').remove())
          .call(g => g.selectAll('line').attr('stroke', '#e0e0e0').attr('stroke-opacity', 0.7));
      }

      const top10 = all.slice(0, 10);
      draw(top10, true);

      sel.onchange = e => {
        const chosen = e.target.value;
        let subset = top10;
        if (!top10.find(d => d.nationality === chosen)) {
          subset = [...top10, all.find(d => d.nationality === chosen)];
        }
        draw(subset);
      };
      addSource(
        'Data Source: ABS Census DataPacks',
        'https://www.abs.gov.au/census/find-census-data/datapacks'
      );
    });
}

/* --- bar‑chart race --- */
function viewNationalityRace(code, lgaName) {
  fetch(`/api/lga/nationalities-race/${code}`)
    .then(r => r.json())
    .then(raw => {
      const years = [...new Set(raw.map(d => d.year))].sort((a, b) => a - b);
      const cumulativeByYear = new Map();
      const running = new Map();
      years.forEach(yr => {
        raw.filter(d => d.year === yr).forEach(d => {
          running.set(d.nationality, (running.get(d.nationality) || 0) + d.count);
        });
        cumulativeByYear.set(yr, new Map(running));
      });

      const frames = [];
      for (let i = 0; i < years.length - 1; i++) {
        const y0 = years[i], y1 = years[i + 1];
        const t0 = cumulativeByYear.get(y0), t1 = cumulativeByYear.get(y1);
        const span = y1 - y0;
        for (let off = 0; off < span; off++) {
          const year = y0 + off;
          const interp = [...new Set([...t0.keys(), ...t1.keys()])].map(nat => {
            const c0 = t0.get(nat) || 0;
            const c1 = t1.get(nat) || c0;
            return { nationality: nat, count: c0 + (c1 - c0) * (off / span) };
          });
          frames.push({ year, rows: interp.sort((a, b) => b.count - a.count).slice(0, 10) });
        }
      }
      const last = years[years.length - 1];
      frames.push({
        year: last,
        rows: [...cumulativeByYear.get(last).entries()].map(([n, c]) => ({ nationality: n, count: c }))
                                        .sort((a, b) => b.count - a.count).slice(0, 10)
      });

      showPanel('Arrivals 1951–2021');
      
      const svg = d3.select(plotEl).append('svg').attr('width', 900).attr('height', 550);
      const m = { top: 60, right: 90, bottom: 60, left: 200 };
      const w = +svg.attr('width') - m.left - m.right;
      const h = +svg.attr('height') - m.top - m.bottom;
      const g = svg.append('g').attr('transform', `translate(${m.left},${m.top})`);
      const x = d3.scaleLinear().range([0, w]);
      const y = d3.scaleBand().range([0, h]).padding(0.1);
      const fmt = d3.format(',d');
      const allNats = [...new Set(raw.map(d => d.nationality))];
      const colour = d3.scaleOrdinal().domain(allNats)
        .range(d3.quantize(d3.interpolateSinebow, allNats.length));

      const yAxisG = g.append('g');
      const xAxisTop = g.append('g');
      const yearLabel = svg.append('text')
        .attr('x', m.left + w)
        .attr('y', m.top + h + 30)
        .attr('text-anchor', 'end')
        .attr('font-size', 22)
        .attr('font-weight', 'bold');

        const titleG = svg.append('g')
        .attr('class', 'plot-title')
        .attr('transform', `translate(${m.left + w / 2}, 20)`);

      const titleTxt = titleG.append('text')
        .attr('text-anchor', 'middle')
        .attr('font-weight', 'bold')
        .attr('font-size', '22px')
        .text(`Number of Yearly Arrivals in ${lgaName}`);

      const iconSize = 30;                                
      const txtBox   = titleTxt.node().getBBox();

      titleG.append('svg')                                
        .attr('x',  txtBox.width / 2 + 3)              
        .attr('y', -iconSize / 2)                       
        .attr('width',  iconSize)
        .attr('height', iconSize)
        .html(`
       <path d="M9.5 1.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0M6.44 3.752A.75.75 0 0 1 7 3.5h1.445c.742 0 1.32.643 1.243 1.38l-.43 4.083a1.8 1.8 0 0 1-.088.395l-.318.906.213.242a.8.8 0 0 1 .114.175l2 4.25a.75.75 0 1 1-1.357.638l-1.956-4.154-1.68-1.921A.75.75 0 0 1 6 8.96l.138-2.613-.435.489-.464 2.786a.75.75 0 1 1-1.48-.246l.5-3a.75.75 0 0 1 .18-.375l2-2.25Z"/>
      <path d="M6.25 11.745v-1.418l1.204 1.375.261.524a.8.8 0 0 1-.12.231l-2.5 3.25a.75.75 0 1 1-1.19-.914zm4.22-4.215-.494-.494.205-1.843.006-.067 1.124 1.124h1.44a.75.75 0 0 1 0 1.5H11a.75.75 0 0 1-.531-.22Z"/>
    `);   // person-walking icon

      function render(frame) {
        const t = svg.transition().duration(250).ease(d3.easeLinear);
        x.domain([0, d3.max(frame.rows, d => d.count)]);
        y.domain(frame.rows.map(d => d.nationality));

        const bars = g.selectAll('rect').data(frame.rows, d => d.nationality);
        bars.exit().transition(t).attr('width', 0).remove();
        const enter = bars.enter().append('rect')
          .attr('x', 0)
          .attr('y', d => y(d.nationality))
          .attr('height', y.bandwidth())
          .attr('fill', d => colour(d.nationality))
          .attr('width', 0);
        enter.merge(bars).transition(t)
          .attr('y', d => y(d.nationality))
          .attr('width', d => x(d.count));

        const labels = g.selectAll('text.barLbl').data(frame.rows, d => d.nationality);
        labels.exit().remove();
        labels.enter().append('text').attr('class', 'barLbl')
          .attr('text-anchor', 'start')
          .attr('dy', '0.35em')
          .merge(labels)
          .transition(t)
          .attr('x', d => x(d.count) + 6)
          .attr('y', d => y(d.nationality) + y.bandwidth() / 2)
          .tween('text', function (d) {
            const i = d3.interpolateNumber(+this.textContent.replace(/,/g, '') || 0, d.count);
            return t => this.textContent = fmt(i(t));
          });

        xAxisTop.transition(t).attr('transform', 'translate(0,0)').call(d3.axisTop(x).ticks(4));
        yAxisG.transition(t).call(d3.axisLeft(y));
        yearLabel.text(frame.year);
      }

      let idx = 0;
      render(frames[idx]);
      const timer = d3.interval(() => {
        idx += 1;
        if (idx >= frames.length) timer.stop();
        else render(frames[idx]);
      }, 250);

      addSource(
        'Data Source: ABS Census DataPacks',
        'https://www.abs.gov.au/census/find-census-data/datapacks'
      );
    });
}




</script>
</body>
</html>

